<template>
  <template v-if="periods.length > 0 && normals && anyData()">
    <!-- Toolbar -->
    <div class="d-flex mt-n2 py-2 sticky-top bg-white">
      <!-- Sections -->
      <Sections ref="sections" />
      <!-- Reference Periods -->
      <div class="ms-auto">
        <div class="dropdown">
          <button
            class="btn btn-light dropdown-toggle"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <icon :icon="['fas', 'history']" />
            <span class="ms-2">
              <template v-if="activePeriod === null">{{ t('latest') }}</template>
              <template v-else>{{ activePeriod }} - {{ activePeriod + 29 }}</template>
            </span>
          </button>
          <ul class="dropdown-menu">
            <li>
              <a
                :class="{ active: activePeriod === null }"
                class="dropdown-item"
                @click="setPeriod(null)"
              >{{ t('latest') }}</a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li
              v-for="period in periods"
              :key="period.start"
            >
              <a
                :class="{ active: period.start === activePeriod }"
                class="dropdown-item"
                @click="setPeriod(period.start)"
              >{{ period.start }} - {{ period.end }}</a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="mt-2 pt-1">
      <!-- Guide -->
      <Guide
        id="climate"
        :text="t('$manual')"
      />
      <!-- Interpolation Info -->
      <InterpolationAlert
        v-if="!station"
        :stations="meta.stations"
      />
      <!-- Briefing -->
      <div class="row">
        <div class="col-6 pe-1 pe-md-3">
          <!-- Average Temperature -->
          <div
            class="card d-flex flex-row overflow-hidden py-1 rounded shadow-sm card-kpi card-temp h-100"
          >
            <div class="card-body py-2">
              <h5 class="card-title">
                <template v-if="tavgKPI !== null && anyColData('tavg')">
                  {{ tavgKPI }}
                  <small class="text-muted ms-1">Â°C</small>
                </template>
                <template v-else>
                  <span class="text-muted">{{ t('$phrases.noData') }}</span>
                </template>
              </h5>
              <span class="card-text text-muted text-truncate">{{ t('$params.tavg') }}</span>
            </div>
            <div class="card-icon d-none d-lg-block">
              <icon :icon="['fas', 'temperature-high']" />
            </div>
          </div>
        </div>
        <div class="col-6 ps-1 ps-md-3">
          <!-- Total Precipitation -->
          <div
            class="card d-flex flex-row overflow-hidden py-1 rounded shadow-sm card-kpi card-prcp h-100"
          >
            <div class="card-body py-2">
              <h5 class="card-title">
                <template v-if="prcpKPI !== null && anyColData('prcp')">
                  {{ prcpKPI }}
                  <small class="text-muted ms-1">mm</small>
                </template>
                <template v-else>
                  <span class="text-muted">{{ t('$phrases.noData') }}</span>
                </template>
              </h5>
              <span class="card-text text-muted text-truncate">{{ t('$params.prcp') }}</span>
            </div>
            <div class="card-icon d-none d-lg-block">
              <icon :icon="['fas', 'umbrella']" />
            </div>
          </div>
        </div>
      </div>

      <div class="my-3">
        <Ad slot="1641693690" />
      </div>

      <div
        id="sections"
        class="mt-4"
      >
        <!-- Temperature Chart -->
        <section
          v-if="anyColData('tavg') || anyColData('tmin') || anyColData('tmax')"
          id="temp"
          class="card mt-3 mt-md-4"
        >
          <div class="card-header card-header-main px-0 rounded-0 bg-white">
            <h2 class="card-header-title lead">
              {{ t('$meteo.temp') }}
            </h2>
          </div>
          <div class="card-body px-0">
            <Chart
              type="line"
              :data="tempChart.data"
              :options="tempChart.options"
            />
          </div>
        </section>
        <!-- Precipitation Chart -->
        <section
          v-if="anyColData('prcp')"
          id="prcp"
          class="card mt-3 mt-md-4"
        >
          <div class="card-header card-header-main px-0 rounded-0 bg-white">
            <h2 class="card-header-title lead">
              {{ t('$meteo.prcp') }}
            </h2>
          </div>
          <div class="card-body px-0">
            <Chart
              type="bar"
              :data="prcpChart.data"
              :options="prcpChart.options"
            />
          </div>
        </section>
        <!-- Wind Speed Chart -->
        <section
          v-if="anyColData('wspd')"
          id="wspd"
          class="card mt-3 mt-md-4"
        >
          <div class="card-header card-header-main px-0 rounded-0 bg-white">
            <h2 class="card-header-title lead">
              {{ t('$params.wspd') }}
            </h2>
          </div>
          <div class="card-body px-0">
            <Chart
              type="line"
              :data="wspdChart.data"
              :options="wspdChart.options"
            />
          </div>
        </section>
        <!-- Air Pressure Chart -->
        <section
          v-if="anyColData('pres')"
          id="pres"
          class="card mt-3 mt-md-4"
        >
          <div class="card-header card-header-main px-0 rounded-0 bg-white">
            <h2 class="card-header-title lead">
              {{ t('$params.pres') }}
            </h2>
          </div>
          <div class="card-body px-0">
            <Chart
              type="bar"
              :data="presChart.data"
              :options="presChart.options"
            />
          </div>
        </section>
        <!-- Sunshine Chart -->
        <section
          v-if="anyColData('tsun')"
          id="tsun"
          class="card mt-3 mt-md-4"
        >
          <div class="card-header card-header-main px-0 rounded-0 bg-white">
            <h2 class="card-header-title lead">
              {{ t('$params.tsun') }}
            </h2>
          </div>
          <div class="card-body px-0">
            <Chart
              type="bar"
              :data="tsunChart.data"
              :options="tsunChart.options"
            />
          </div>
        </section>
      </div>
    </div>
  </template>
  <!-- No Data -->
  <template v-else-if="meta.generated">
    <NoData />
  </template>
</template>

<script lang="ts">
import { defineComponent, defineAsyncComponent } from 'vue'
import { useI18n } from 'vue-i18n'
import { useHead } from '@vueuse/head'
import { Store } from 'pinia'
import { useSettingsStore } from '~/stores/settings'
import { ChartDefinitionInterface } from '~/utils/interfaces'
import DataMixin from '../Location.mixin'
import { tsTooltips } from '~/components/charts/timeseries.config'
import Sections from '../Sections.vue'
import Guide from '~/components/Guide.vue'
import Ad from '~/components/Ad.vue'
import Chart from '../charts/Chart.vue'

/**
 * Async Components
 */
const InterpolationAlert = defineAsyncComponent(() =>
  import('~/components/alerts/Interpolation.vue')
)
const NoData = defineAsyncComponent(() =>
  import('./NoData.vue')
)

export default defineComponent({
  name: 'Climate',

  components: {
    Sections,
    InterpolationAlert,
    Chart,
    NoData,
    Guide,
    Ad
  },

  mixins: [DataMixin],

  props: {
    name: {
      type: String,
      default: null
    },
    station: {
      type: String,
      default: null
    },
    lat: {
      type: Number,
      default: null
    },
    lon: {
      type: Number,
      default: null
    },
    alt: {
      type: Number,
      default: null
    }
  },

  setup(props: Record<string, any>): Record<string, (Store|Array<string>|any)> {
    // Translations
    const { t } = useI18n()

    // Store
    const settings = useSettingsStore()

    // Meta tags
    useHead({
      title: `${props.name} | ${t('$meta.title')} | Meteostat`
    })

    return {
      t,
      settings
    }
  },

  data(): Record<string, any> {
    return {
      meta: {},
      normals: null,
      activePeriod: null
    }
  },

  computed: {
    periods(): Array<Record<string, number>> {
      const periods: Array<Record<string, number>> = []
      this.normals?.forEach((record: any): void => {
        if (!periods.map(period => period.start).includes(record.start)) {
          periods.push({
            start: record.start,
            end: record.end
          })
        }
      })
      return periods
    },

    data(): any {
      let data: Record<string, any> = []
      if (this.activePeriod === null) {
        this.normals?.forEach((record: any): void => {
          data[record.month - 1] = {
            tavg: record.tavg || data[record.month - 1]?.tavg || null,
            tmin: record.tmin || data[record.month - 1]?.tmin || null,
            tmax: record.tmax || data[record.month - 1]?.tmax || null,
            wspd: record.wspd || data[record.month - 1]?.wspd || null,
            prcp: record.prcp || data[record.month - 1]?.prcp || null,
            pres: record.pres || data[record.month - 1]?.pres || null,
            tsun: record.tsun || data[record.month - 1]?.tsun || null
          }
        })
      }
      else {
        data = this.normals?.filter((record: any): boolean => {
          return record.start === this.activePeriod
        })
      }
      return data
    },

    tavgKPI(): string|null {
      const tavg = this.fetchValues('tavg').filter(t => t !== null)
      if (tavg.length > 0) {
        const sum = tavg.reduce((a, b) => Number(a) + Number(b), 0)
        const avg = (Number(sum) / tavg.length);
        return avg.toFixed(1)
      }
      return null
    },

    prcpKPI(): null|string {
      const prcp = this.fetchValues('prcp').filter(p => p !== null)
      if (prcp.length > 0) {
        const sum = prcp.reduce((a, b) => Number(a) + Number(b), 0)
        return Number(sum).toFixed(1)
      }
      return null
    },

    /**
     * Configuration for temperature chart
     * 
     * @returns {Object} Configuration object
     */
    tempChart(): ChartDefinitionInterface {
      return {
        data: {
          labels: [...Array(12).keys()].map(key => this.t(`$months[${key}]`)),
          datasets: [{
            label: this.t('$params.tavg'),
						type: 'line',
						fill: false,
						lineTension: 0.1,
						borderColor: "rgb(85,85,85)",
            backgroundColor: "rgb(85,85,85)",
						pointBorderColor: "rgb(255,255,255)",
						data: this.fetchValues('tavg')
					}, {
            label: this.t('$params.tmin'),
						type: 'bar',
						backgroundColor: "rgba(51,122,183,0.8)",
						data: this.fetchValues('tmin')
					}, {
            label: this.t('$params.tmax'),
						type: 'bar',
						backgroundColor: "rgba(217,83,79,0.8)",
						data: this.fetchValues('tmax')
					}]
        },
        options: {
          scales: {
            y: {
              title: {
                text: this.settings.units.temp
              }
            }
          },
          plugins: {
            tooltip: tsTooltips
          }
        }
      }
    },

    /**
     * Configuration for precipitation chart
     * 
     * @returns {Object} Configuration object
     */
    prcpChart(): ChartDefinitionInterface {
      return {
        data: {
          labels: [...Array(12).keys()].map(key => this.t(`$months[${key}]`)),
          datasets: [{
            label: this.t('$params.prcp'),
            borderWidth: 2,
            borderColor: "rgb(91,192,222)",
            backgroundColor: "rgb(91,192,222)",
            data: this.fetchValues('prcp')
          }]
        },
        options: {
          scales: {
            y: {
              title: {
                text: this.settings.units.prcp
              }
            }
          },
          plugins: {
            tooltip: tsTooltips
          }
        }
      }
    },

    /**
     * Configuration for wind speed chart
     * 
     * @returns {Object} Configuration object
     */
    wspdChart(): ChartDefinitionInterface {
      return {
        data: {
          labels: [...Array(12).keys()].map(key => this.t(`$months[${key}]`)),
          datasets: [{
            label: this.t('$params.wspd'),
            borderWidth: 2,
            borderColor: "rgb(51,122,183)",
            backgroundColor: "rgb(51,122,183)",
            fill: false,
            pointBorderColor: "rgb(255,255,255)",
            pointRadius: 4,
            data: this.fetchValues('wspd')
          }]
        },
        options: {
          scales: {
            y: {
              title: {
                text: this.settings.units.wspd
              }
            }
          },
          plugins: {
            tooltip: tsTooltips
          }
        }
      }
    },

    /**
     * Configuration for air pressure chart
     * 
     * @returns {Object} Configuration object
     */
    presChart(): ChartDefinitionInterface {
      return {
        data: {
          labels: [...Array(12).keys()].map(key => this.t(`$months[${key}]`)),
          datasets: [{
            label: this.t('$params.pres'),
            borderWidth: 2,
            borderColor: "rgb(92,184,92)",
            backgroundColor: "rgb(92,184,92)",
            fill: false,
            data: this.fetchValues('pres')
          }]
        },
        options: {
          scales: {
            y: {
              title: {
                text: 'hPa'
              },
              beginAtZero: false
            }
          },
          plugins: {
            tooltip: tsTooltips
          }
        }
      }
    },

    /**
     * Configuration for sunshine duration chart
     * 
     * @returns {Object} Configuration object
     */
    tsunChart(): ChartDefinitionInterface {
      return {
        data: {
          labels: [...Array(12).keys()].map(key => this.t(`$months[${key}]`)),
          datasets: [{
            label: this.t('$params.tsun'),
            borderWidth: 2,
            borderColor: "rgb(253,126,20)",
            backgroundColor: "rgb(253,126,20)",
            data: this.fetchValues('tsun')
          }]
        },
        options: {
          scales: {
            y: {
              title: {
                text: 'm'
              }
            }
          },
          plugins: {
            tooltip: tsTooltips
          }
        }
      }
    }
  },

  async mounted() {
    await this.fetchNormalsData()
  },

  updated(): void {
   // Update sections
   (this.$refs as any).sections?.update()
  },

  methods: {
    /**
     * Fetch climate normals data
     */
    async fetchNormalsData(): Promise<void> {
      // Set loading state
      this.$loading('normals')
      // URL
      let url = `${this.$api}/app/proxy/`
      if (this.station) {
        url += `stations/normals?station=${this.station}`
      } else {
        url += `point/normals?lat=${this.lat}&lon=${this.lon}&alt=${this.alt}`
      }
      // Imperial units?
      if (this.settings.imperial) {
        url += '&units=imperial'
      }
      // Fetch data
      await fetch(url)
        .then(response => response.json())
        .then(data => {
          this.meta = data.meta
          this.normals = data.data
        })
        .finally(() => this.$loaded('normals'))
    },

    setPeriod(period: number): void {
      this.activePeriod = period
    }
  }
})
</script>

<i18n>
{
  "en": {
    "$meta": {
      "title": "Climate Data"
    },
    "latest": "Latest",
    "$manual": "Climate data provides information on the typical weather at a location. The normals are usually based on a period of 30 years. At Meteostat you can view data for all available reference periods. Inconsistencies can occur between the individual periods, as not all statistics were generated using the same methods.",
    "$months": [
      "JAN",
      "FEB",
      "MAR",
      "APR",
      "MAY",
      "JUN",
      "JUL",
      "AUG",
      "SEP",
      "OCT",
      "NOV",
      "DEC"
    ]
  },
  "de": {
    "$meta": {
      "title": "Klimadaten"
    },
    "latest": "Neueste",
    "$manual": "Klimadaten liefern Informationen Ã¼ber das typische Wetter an einem Ort. Die Normalwerte beziehen sich in der Regel auf einen Zeitraum von 30 Jahren. Bei Meteostat kÃ¶nnen Sie die Daten fÃ¼r alle verfÃ¼gbaren ReferenzzeitrÃ¤ume einsehen. Zwischen den einzelnen ZeitrÃ¤umen kann es zu Inkonsistenzen kommen, da nicht alle Statistiken mit den gleichen Methoden erstellt wurden.",
    "$months": [
      "JAN",
      "FEB",
      "MAR",
      "APR",
      "MAI",
      "JUN",
      "JUL",
      "AUG",
      "SEP",
      "OKT",
      "NOV",
      "DEZ"
    ]
  },
  "it": {
    "$meta": {
      "title": "Dati climatici"
    },
    "latest": "Ultimo",
    "$manual": "I dati climatici forniscono informazioni sul tempo tipico di una localitÃ . Le norme sono solitamente basate su un periodo di 30 anni. Su Meteostat Ã¨ possibile visualizzare i dati per tutti i periodi di riferimento disponibili. Possono verificarsi incongruenze tra i singoli periodi, poichÃ© non tutte le statistiche sono state generate con gli stessi metodi.",
    "$months": [
      "JAN",
      "FEB",
      "MAR",
      "APR",
      "MAY",
      "JUN",
      "JUL",
      "AUG",
      "SEP",
      "OCT",
      "NOV",
      "DEC"
    ]
  },
  "es": {
    "$meta": {
      "title": "Datos ClimÃ¡ticos"
    },
    "latest": "MÃ¡s Reciente",
    "$manual": "Los datos climÃ¡ticos proporcionan informaciÃ³n sobre el tiempo tÃ­pico en un lugar. Los valores normales suelen basarse en un periodo de 30 aÃ±os. En Meteostat puede ver los datos de todos los perÃ­odos de referencia disponibles. Pueden producirse incoherencias entre los distintos perÃ­odos, ya que no todas las estadÃ­sticas se generaron con los mismos mÃ©todos.",
    "$months": [
      "JAN",
      "FEB",
      "MAR",
      "APR",
      "MAY",
      "JUN",
      "JUL",
      "AUG",
      "SEP",
      "OCT",
      "NOV",
      "DEC"
    ]
  },
  "nl": {
    "$meta": {
      "title": "Climate Data"
    },
    "latest": "Laatste",
    "$manual": "Klimaatgegevens geven informatie over het typische weer op een locatie. De normalen zijn meestal gebaseerd op een periode van 30 jaar. Bij Meteostat kunt u gegevens bekijken voor alle beschikbare referentieperioden. Er kunnen inconsistenties optreden tussen de afzonderlijke perioden, omdat niet alle statistieken volgens dezelfde methoden zijn gegenereerd.",
    "$months": [
      "JAN",
      "FEB",
      "MAR",
      "APR",
      "MAY",
      "JUN",
      "JUL",
      "AUG",
      "SEP",
      "OCT",
      "NOV",
      "DEC"
    ]
  },
  "fr": {
    "$meta" : {
      "title" : "DonnÃ©es Climatiques"
    },
    "latest" : "Les plus rÃ©cents",
    "$manual" : "Les donnÃ©es climatiques fournissent des informations sur les conditions mÃ©tÃ©orologiques typiques d'un lieu. Les normales sont gÃ©nÃ©ralement basÃ©es sur une pÃ©riode de 30 ans. Sur Meteostat, vous pouvez consulter les donnÃ©es pour toutes les pÃ©riodes de rÃ©fÃ©rence disponibles. Des incohÃ©rences peuvent apparaÃ®tre entre les diffÃ©rentes pÃ©riodes, car toutes les statistiques n'ont pas Ã©tÃ© gÃ©nÃ©rÃ©es en utilisant les mÃªmes mÃ©thodes.",
    "$months": [
      "JAN",
      "FEB",
      "MAR",
      "APR",
      "MAY",
      "JUN",
      "JUL",
      "AUG",
      "SEP",
      "OCT",
      "NOV",
      "DEC"
    ]
  },
  "pt": {
    "$meta": {
      "title": "Dados ClimÃ¡ticos"
    },
    "latest": "Mais Recente",
    "$manual": "Os dados climÃ¡ticos fornecem informaÃ§Ãµes sobre o tempo tÃ­pico de um local. As normas sÃ£o normalmente baseadas num perÃ­odo de 30 anos. No Meteostat Ã© possÃ­vel visualizar dados para todos os perÃ­odos de referÃªncia disponÃ­veis. Podem ocorrer inconsistÃªncias entre os perÃ­odos individuais, uma vez que nem todas as estatÃ­sticas foram geradas utilizando os mesmos mÃ©todos.",
    "$months": [
      "JAN",
      "FEB",
      "MAR",
      "APR",
      "MAY",
      "JUN",
      "JUL",
      "AUG",
      "SEP",
      "OCT",
      "NOV",
      "DEC"
    ]
  },
  "ru": {
    "$meta": {
      "title": "ÐÐ»Ð¸Ð¼Ð°ÑÐ¸ÑÐµÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½ÑÐµ"
    },
    "latest": "ÐÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ",
    "$manual": "ÐÐ»Ð¸Ð¼Ð°ÑÐ¸ÑÐµÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½ÑÐµ Ð¿ÑÐµÐ´Ð¾ÑÑÐ°Ð²Ð»ÑÑÑ Ð¸Ð½ÑÐ¾ÑÐ¼Ð°ÑÐ¸Ñ Ð¾ ÑÐ¸Ð¿Ð¸ÑÐ½Ð¾Ð¹ Ð¿Ð¾Ð³Ð¾Ð´Ðµ Ð² ÑÐ¾Ð¼ Ð¸Ð»Ð¸ Ð¸Ð½Ð¾Ð¼ Ð¼ÐµÑÑÐµ. ÐÐ¾ÑÐ¼Ð°Ð»ÑÐ½ÑÐµ Ð¿Ð¾ÐºÐ°Ð·Ð°ÑÐµÐ»Ð¸ Ð¾Ð±ÑÑÐ½Ð¾ Ð¾ÑÐ½Ð¾Ð²ÑÐ²Ð°ÑÑÑÑ Ð½Ð° Ð¿ÐµÑÐ¸Ð¾Ð´Ðµ Ð² 30 Ð»ÐµÑ. Ð Meteostat Ð²Ñ Ð¼Ð¾Ð¶ÐµÑÐµ Ð¿ÑÐ¾ÑÐ¼Ð¾ÑÑÐµÑÑ Ð´Ð°Ð½Ð½ÑÐµ Ð·Ð° Ð²ÑÐµ Ð´Ð¾ÑÑÑÐ¿Ð½ÑÐµ Ð¿ÐµÑÐ¸Ð¾Ð´Ñ. ÐÐµÐ¶Ð´Ñ Ð¾ÑÐ´ÐµÐ»ÑÐ½ÑÐ¼Ð¸ Ð¿ÐµÑÐ¸Ð¾Ð´Ð°Ð¼Ð¸ Ð¼Ð¾Ð³ÑÑ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ°ÑÑ Ð½ÐµÑÐ¾Ð¾ÑÐ²ÐµÑÑÑÐ²Ð¸Ñ, Ð¿Ð¾ÑÐºÐ¾Ð»ÑÐºÑ Ð½Ðµ Ð²ÑÐµ ÑÑÐ°ÑÐ¸ÑÑÐ¸ÑÐµÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½ÑÐµ Ð±ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑÑÐµÐ½Ñ Ñ Ð¸ÑÐ¿Ð¾Ð»ÑÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð¾Ð´Ð½Ð¸Ñ Ð¸ ÑÐµÑ Ð¶Ðµ Ð¼ÐµÑÐ¾Ð´Ð¾Ð².",
    "$months": [
      "JAN",
      "FEB",
      "MAR",
      "APR",
      "MAY",
      "JUN",
      "JUL",
      "AUG",
      "SEP",
      "OCT",
      "NOV",
      "DEC"
    ]
  }
}
</i18n>